# Arch Linux Dev Container
# Used for working on most of my projects
#
# Build local with `docker build -t archlinux-dev:latest .`
# Build remote with `docker build -t archlinux-dev:latest https://raw.githubusercontent.com/overshard/dockerfiles/master/dev/Dockerfile`
#
# Create volumes with `docker volume create --name home-code` and `docker volume create --name home-code`
# Run container with volumes `docker run --detach --restart always --name home-container --volume home-code:/home/dev/code --volume home-ssh:/home/dev/.ssh alpinelinux-dev:latest`

FROM archlinux:latest


# Install packages

RUN pacman --sync --refresh --noconfirm \
        git curl openssh neovim chromium libwebp \
        noto-fonts noto-fonts-extra noto-fonts-emoji \
        base-devel openssl zlib xz tk \
        postgresql postgresql-libs \
        redis


# Setup postgresql

RUN sudo -iu postgres initdb -D /var/lib/postgres/data && \
    mkdir -p /run/postgresql && \
    chown postgres:postgres /run/postgresql && \
    sudo -iu postgres pg_ctl start -D /var/lib/postgres/data && \
    sudo -iu postgres createuser -s dev && \
    sudo -iu postgres pg_ctl stop -D /var/lib/postgres/data


# Setup redis

RUN sed -i 's/stop-writes-on-bgsave-error yes/stop-writes-on-bgsave-error no/g' /etc/redis/redis.conf


# Set up supervisor to run our services

RUN echo $'# supervisor\n\
[supervisord]\n\
pidfile=/run/supervisord.pid\n\
user=root\n\
nodaemon=true\n\
logfile=/dev/null\n\
logfile_maxbytes=0\n\
# postgresql\n\
[program:postgresql]\n\
command=/usr/bin/postgres -D /var/lib/postgres/data\n\
autostart=true\n\
user=postgres\n\
stdout_logfile=/dev/fd/1\n\
stdout_logfile_maxbytes=0\n\
redirect_stderr=true\n\
# redis\n\
[program:redis]\n\
command=/usr/bin/redis-server\n\
autostart=true\n\
user=redis\n\
stdout_logfile=/dev/fd/1\n\
stdout_logfile_maxbytes=0\n\
redirect_stderr=true\n\
' >> /etc/supervisord.conf && chmod 600 /etc/supervisord.conf


# Setup a symbolic link to maintain cross platform compatibility with chromium

RUN ln -s /usr/bin/chromium /usr/sbin/chromium-browser


# Setup our timezone in /etc/timezone to prevent python tz errors

RUN echo UTC > /etc/timezone


# Create a user

RUN useradd -m -G wheel -s /bin/bash dev && \
    echo "dev:password" | chpasswd && \
    echo "dev ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers.d/dev


# Use our new user and an interactive shell to load .bashrc

USER dev

SHELL ["/bin/bash", "-l", "-i", "-c"]


# Install python and system packages

RUN curl -o- https://raw.githubusercontent.com/pyenv/pyenv-installer/master/bin/pyenv-installer | bash

RUN echo $'# pyenv\n\
export PYENV_ROOT="$HOME/.pyenv"\n\
command -v pyenv >/dev/null || export PATH="$PYENV_ROOT/bin:$PATH"\n\
eval "$(pyenv init -)"\n\
' >> ~/.bashrc

RUN pyenv install 3.10.4 && \
    pyenv global 3.10.4 && \
    pip install --upgrade \
        pip \
        pipenv \
        black \
        isort \
        flake8 \
        supervisor


# Install node and system packages

RUN curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/master/install.sh | bash

RUN nvm install --lts=fermium && \
    npm i -g \
        yarn \
        prettier \
        import-sort \
        eslint \
        gulp-cli \
        vercel \
        heroku


# Add my dotfiles

RUN curl -o- https://raw.githubusercontent.com/overshard/dotfiles/master/bootstrap.sh | bash


# Run our supervisor services with CMD so we can override if it we want to

CMD ["sudo", "/home/dev/.pyenv/shims/supervisord", "-c", "/etc/supervisord.conf"]
